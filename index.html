<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="VRC MMD World Seacrh / VRC MMD 월드 곡 검색기">
    <meta name="author" content="Sui Sensei / 스이 센세">
    <meta name="og:site_name" content="VRC MMD World Search">
    <meta name="og:title" content="VRC MMD Worlds">
    <meta name="og:image" content="static/img/icon/favi.ico">
    <meta name="og:thumbnail" content="static/img/icon/favi.ico">
    <title>VRC MMD Worlds</title>
    <link rel="icon" href="static/img/icon/favi.ico">
    <link rel="stylesheet" href="static/css/style.css">
    <script>
        const music_ep = "https://gist.githubusercontent.com/DetegiCE/214a5f645c09e0e14b368a38b7d34ef8/raw/e01b291d8b0c743dc5520dad9fd494af64ba77ec/mmd_music.json";
        const world_ep = "https://gist.githubusercontent.com/DetegiCE/78d8cd1d09c3dd2ba40d88816fd99360/raw/003110bc8484feae1ef4b9da321105a27d2f53ab/mmd_world.json";
        const world_music_ep = "https://gist.githubusercontent.com/DetegiCE/e6e821786ad37b73f2e499c11d4a0cd6/raw/aacde3fdaea6d91d266f3d31557cb8ae9fcae9fe/mmd_world_music.json";

        let music_data = [];
        let world_data = [];
        let world_music_data = [];

        getMusic().then(data => music_data = data).then(() => listMusic());
        getWorld().then(data => world_data = data);
        getWorldMusic().then(data => world_music_data = data);

        async function getMusic() {
            const response = await fetch(music_ep);
            const data = await response.json();
            return data;
        }

        async function getWorld() {
            const response = await fetch(world_ep);
            const data = await response.json();
            return data;
        }

        async function getWorldMusic() {
            const response = await fetch(world_music_ep);
            const data = await response.json();
            return data;
        }

        function searchMusic() {
            const search = document.querySelector("#musicSearch").value;

            let spl = search.split("");
            let regex = '.*' + spl.join(".*") + '.*';

            const result = music_data.filter(music => music.title.match(new RegExp(regex, "gi") || music.alias.match(new RegExp(regex, "gi"))));

            const songname = document.querySelector("#songname");
            songname.textContent = result[0].title + " (" + result[0].cnt + ")";
            const resultId = result[0].id;

            const worldList = document.querySelector("#worldList");
            worldList.innerHTML = "";
            const resultWorld = world_music_data.filter(world => world.musicid === resultId);
            console.log(resultWorld);

            resultWorld.forEach(world => {
                const li = document.createElement("li");
                const id = world.worldid;
                const worldname = world_data.find(w => w.id === id).name;
                const worldid = world_data.find(w => w.id === id).worldid;
                const author = world_data.find(w => w.id === id).author;
                li.innerHTML = `
                    <img src="static/img/world/${id}.png" alt="${worldname}">
                    <h2>${worldname} <span>by ${author}</span></h2>
                    <a href="https://vrchat.com/home/world/${worldid}" target="_blank">바로가기</a>
                `;
                worldList.append(li);
            });
        }

        function listMusic() {
            const search = document.querySelector("#musicSearch").value;

            let spl = search.split("");
            let regex = '.*' + spl.join(".*") + '.*';

            const result = music_data.filter(music => (music.title.match(new RegExp(regex, "gi")) || music.alias.match(new RegExp(regex, "gi"))));

            const musicList = document.querySelector("#musicList");
            musicList.innerHTML = "";
            result.forEach(music => {
                const li = document.createElement("li");
                li.textContent = music.title + " (" + music.cnt + ")";
                li.onclick = function () {
                    document.querySelector("#musicSearch").value = music.title;
                    searchMusic();
                }
                musicList.appendChild(li);
            });
        }
    </script>
</head>

<body>
    <div id="container">
        <header>
            <h1>MMD Music Searcher</h1>
        </header>
        <section id="searchBox">
            <form action="" onsubmit="return false;">
                <input type="search" id="musicSearch" oninput="listMusic()" autocomplete="off">
                <input type="submit" value="검색" onclick="searchMusic()">
            </form>
            <ul id="musicList"></ul>
            <br>
        </section>
        <section id="resultBox">
            <h1 id="songname"></h1>
            <h2>검색된 월드</h2>
            <ul id="worldList">
            </ul>
        </section>
    </div>
</body>

</html>